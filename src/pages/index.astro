---
import PlotFigure from "../components/PlotFigure.astro";
import Layout from "../layouts/Layout.astro";
import * as Plot from "@observablehq/plot";
import data from "../assets/DataCulturelles2025.json";
import communes from "../assets/communes.json";

const colors = {
  Bordeaux: "#0077B6",
  Montpellier: "#F77F00",
};

const bordeauxGeo = {
  type: "FeatureCollection",
  features: communes.features.filter(
    (d) =>
      d.properties.code === "33063" ||
      d.properties.nom?.toLowerCase() === "bordeaux"
  ),
};

const montpellierGeo = {
  type: "FeatureCollection",
  features: communes.features.filter(
    (d) =>
      d.properties.code === "34172" ||
      d.properties.nom?.toLowerCase() === "montpellier"
  ),
};

const DataCulturellesPhysiques2025 = data.filter(
  (d) => d.type_offre === "physique"
);

const populations = {
  Bordeaux: 1018000,
  Montpellier: 487000,
};

const LieuxParVilleType = ["Bordeaux", "Montpellier", "Talence"]
  .flatMap((ville) => {
    const typesOffre = ["physique", "numérique"];
    return typesOffre.map((type_offre) => {
      const lieux = data.filter(
        (d) => d.ville === ville && d.type_offre === type_offre
      ).length;
      const pop = populations[ville];

      return {
        ville,
        type_offre,
        lieux,
        habitants_par_lieu: pop && lieux > 0 ? Math.round(pop / lieux) : null,
      };
    });
  })
  .filter((d) => d.habitants_par_lieu !== null);

const DataBordeaux = data.filter((d) => d.ville === "Bordeaux");
const DataMontpellier = data.filter((d) => d.ville === "Montpellier");

const typesEquipements = Array.from(
  new Set(
    data
      .filter((d) => d.type_offre === "physique" && d.type_equipement)
      .map((d) => d.type_equipement)
  )
).sort();

const butterflyDataComplete = typesEquipements
  .map((type) => {
    const bordeauxCount = DataBordeaux.filter(
      (d) => d.type_equipement === type && d.type_offre === "physique"
    ).length;

    const montpellierCount = DataMontpellier.filter(
      (d) => d.type_equipement === type && d.type_offre === "physique"
    ).length;

    return [
      {
        type: type,
        count: -bordeauxCount,
        ville: "Bordeaux",
        countAbs: bordeauxCount,
      },
      {
        type: type,
        count: montpellierCount,
        ville: "Montpellier",
        countAbs: montpellierCount,
      },
    ];
  })
  .flat()
  .filter((d) => d.countAbs > 0);

const totalsByType = new Map();
butterflyDataComplete.forEach((d) => {
  const current = totalsByType.get(d.type) || 0;
  totalsByType.set(d.type, current + d.countAbs);
});

const equipementsPertinents = Array.from(totalsByType.entries())
  .filter(([type, count]) => count >= 3)
  .sort((a, b) => b[1] - a[1])
  .slice(0, 10)
  .map(([type]) => type);

const butterflyData = butterflyDataComplete.filter((d) =>
  equipementsPertinents.includes(d.type)
);

const equipementsDomain = Array.from(totalsByType.entries())
  .filter(([type]) => equipementsPertinents.includes(type))
  .sort((a, b) => b[1] - a[1])
  .map(([type]) => type);

const nbPatrimoineBdx = DataBordeaux.filter(
  (d) =>
    d.type_equipement?.toLowerCase().includes("musée") ||
    d.type_equipement?.toLowerCase().includes("monument")
).length;

const nbPatrimoineMtp = DataMontpellier.filter(
  (d) =>
    d.type_equipement?.toLowerCase().includes("musée") ||
    d.type_equipement?.toLowerCase().includes("monument")
).length;

const nbBibliosBdx = DataBordeaux.filter((d) =>
  d.type_equipement?.toLowerCase().includes("bibliothèque")
).length;

const nbBibliosMtp = DataMontpellier.filter((d) =>
  d.type_equipement?.toLowerCase().includes("bibliothèque")
).length;

const nbFestivalsBdx = DataBordeaux.filter((d) =>
  d.type_equipement?.toLowerCase().includes("festival")
).length;

const nbFestivalsMtp = DataMontpellier.filter((d) =>
  d.type_equipement?.toLowerCase().includes("festival")
).length;

const nbNumBdx = DataBordeaux.filter(
  (d) => d.type_offre === "numérique"
).length;
const nbNumMtp = DataMontpellier.filter(
  (d) => d.type_offre === "numérique"
).length;

const nbPhysiqueBdx = DataBordeaux.filter(
  (d) => d.type_offre === "physique"
).length;
const nbPhysiqueMtp = DataMontpellier.filter(
  (d) => d.type_offre === "physique"
).length;

const diversiteBdx = new Set(DataBordeaux.map((d) => d.type_equipement)).size;
const diversiteMtp = new Set(DataMontpellier.map((d) => d.type_equipement))
  .size;

const radarDimensions = [
  {
    label: "Patrimoine\n(Musées + Monuments)\npour 100k hab",
    bordeaux: (nbPatrimoineBdx / populations.Bordeaux) * 100000,
    montpellier: (nbPatrimoineMtp / populations.Montpellier) * 100000,
  },
  {
    label: "Bibliothèques\n(pour 100k hab)",
    bordeaux: (nbBibliosBdx / populations.Bordeaux) * 100000,
    montpellier: (nbBibliosMtp / populations.Montpellier) * 100000,
  },
  {
    label: "Festivals\n(pour 100k hab)",
    bordeaux: (nbFestivalsBdx / populations.Bordeaux) * 100000,
    montpellier: (nbFestivalsMtp / populations.Montpellier) * 100000,
  },
  {
    label: "Innovation\nnumérique\n(pour 100k hab)",
    bordeaux: (nbNumBdx / populations.Bordeaux) * 100000,
    montpellier: (nbNumMtp / populations.Montpellier) * 100000,
  },
  {
    label: "Accessibilité\nphysique globale\n(lieux/1000 hab)",
    bordeaux: (nbPhysiqueBdx / populations.Bordeaux) * 1000,
    montpellier: (nbPhysiqueMtp / populations.Montpellier) * 1000,
  },
  {
    label: "Diversité\ndes équipements\n(types uniques)",
    bordeaux: diversiteBdx,
    montpellier: diversiteMtp,
  },
];

const normalizedRadarDimensions = radarDimensions.map((d) => {
  const maxDimension = Math.max(d.bordeaux, d.montpellier);
  return {
    label: d.label,
    bordeaux: (d.bordeaux / maxDimension) * 100,
    montpellier: (d.montpellier / maxDimension) * 100,
    bordeauxRaw: d.bordeaux,
    montpellierRaw: d.montpellier,
  };
});

const radarData = [];
const n = normalizedRadarDimensions.length;
const angleStep = (2 * Math.PI) / n;

normalizedRadarDimensions.forEach((d, i) => {
  const angle = i * angleStep - Math.PI / 2;
  radarData.push(
    {
      dimension: d.label,
      angle: angle,
      angleDeg: ((angle * 180) / Math.PI + 90) % 360,
      value: d.bordeaux,
      ville: "Bordeaux",
      rawValue: d.bordeauxRaw,
      index: i,
    },
    {
      dimension: d.label,
      angle: angle,
      angleDeg: ((angle * 180) / Math.PI + 90) % 360,
      value: d.montpellier,
      ville: "Montpellier",
      rawValue: d.montpellierRaw,
      index: i,
    }
  );
});
---

<Layout>
  <section
    class="snap-section relative overflow-hidden bg-black min-h-screen flex items-center"
  >
    <div class="absolute inset-0">
      <img
        src="/src/assets/img/fond_bordeaux.jpg"
        alt="Carte de Bordeaux"
        class="w-full h-full object-cover opacity-30 grayscale"
      />
    </div>

    <div
      class="absolute inset-0 bg-gradient-to-b from-black/70 via-black/60 to-black/90"
    >
    </div>

    <div class="absolute inset-0 opacity-[0.02]">
      <div
        class="absolute inset-0"
        style="background-image: repeating-linear-gradient(0deg, transparent, transparent 1px, currentColor 1px, currentColor 2px), repeating-linear-gradient(90deg, transparent, transparent 1px, currentColor 1px, currentColor 2px); background-size: 40px 40px;"
      >
      </div>
    </div>

    <div class="container mx-auto px-6 relative z-10 w-full">
      <div class="max-w-5xl mx-auto text-center fade-in-section">
        <div
          class="text-xs uppercase tracking-[0.2em] text-base-content/40 mb-8"
        >
          SAÉ 303 — Datavisualisation
        </div>

        <h1 class="text-5xl md:text-7xl lg:text-8xl font-serif mb-8">
          Tradition<br />
          <span class="italic">vs</span><br />
          Innovation
        </h1>

        <p
          class="text-xl md:text-2xl text-base-content/60 mb-4 max-w-2xl mx-auto font-light"
        >
          Une exploration comparative des offres culturelles
        </p>

        <div
          class="flex items-center justify-center gap-6 mb-16 text-base-content/50"
        >
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-gray-400"></div>
            <span class="text-sm">Bordeaux</span>
          </div>
          <div class="w-px h-4 bg-base-content/20"></div>
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-white"></div>
            <span class="text-sm">Montpellier</span>
          </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 justify-center mb-20">
          <a
            href="#intro"
            class="btn bg-white text-black hover:bg-gray-200 btn-lg border-0"
          >
            Découvrir l'analyse
          </a>
          <a
            href="#about"
            class="btn btn-ghost btn-lg border border-white/20 hover:bg-white/10"
            >Méthodologie</a
          >
        </div>

        <div
          class="grid grid-cols-1 md:grid-cols-3 gap-12 max-w-4xl mx-auto text-center"
        >
          <div>
            <div class="text-5xl md:text-6xl font-serif mb-2 text-gray-400">
              407
            </div>
            <div class="text-sm text-base-content/60">Monuments à Bordeaux</div>
          </div>
          <div>
            <div class="text-5xl md:text-6xl font-serif mb-2 text-white">
              51
            </div>
            <div class="text-sm text-base-content/60">
              Festivals à Montpellier
            </div>
          </div>
          <div>
            <div class="text-5xl md:text-6xl font-serif mb-2">8</div>
            <div class="text-sm text-base-content/60">Catégories analysées</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section
    id="intro"
    class="snap-section bg-[#F2F2F2] min-h-screen flex items-center"
  >
    <div class="container mx-auto max-w-4xl px-6 py-24">
      <div class="space-y-8 fade-in-section">
        <div class="text-xs uppercase tracking-[0.3em] text-gray-500">
          Introduction
        </div>

        <h2
          class="text-4xl md:text-5xl lg:text-6xl font-serif text-[#111111] leading-tight"
        >
          Culture et numérique : une mutation territoriale
        </h2>

        <div class="prose prose-lg max-w-none">
          <p class="text-xl text-gray-700 leading-relaxed mb-6">
            Dans un monde dans lequel le numérique s'invite dans chaque domaine,
            la culture n'y échappe pas. Les institutions patrimoniales se
            digitalisent, les festivals se diffusent en ligne, les publics se
            diversifient. Dans ce mouvement, les villes deviennent des acteurs
            majeurs de cette mutation culturelle.
          </p>

          <p class="text-xl text-gray-700 leading-relaxed mb-6">
            Pour illustrer cela, notre étude se concentre sur deux acteurs qui
            partagent le statut de métropole culturelle : <span
              class="font-semibold text-[#111111]">Bordeaux</span
            > et <span class="font-semibold text-[#111111]">Montpellier</span>.
            Toutefois, malgré leur statut commun, chacune connaît une évolution
            différente. Bordeaux incarne le visage d'une ville profondément
            ancrée dans un patrimoine historique et muséal, tandis que
            Montpellier représente un pôle d'expérimentation culturelle,
            numérique et un dynamisme dans l'événementiel.
          </p>

          <p class="text-xl text-gray-700 leading-relaxed">
            À travers notre étude, nous souhaitons comparer comment ces deux
            villes adoptent une stratégie bien différente concernant l'accès à
            la culture, croisant leur offre physique (lieux, équipements,
            événements) et leur offre numérique (innovations, lieux de création
            de contenus culturels numériques, médiations). Cela nous laisse une
            ouverture sur l'avenir de la culture en France, entre préservation
            et transition numérique.
          </p>
        </div>
      </div>
    </div>
  </section>

  <section
    id="chapitre-01"
    class="snap-section bg-[#F2F2F2] min-h-screen flex items-center"
  >
    <div class="container mx-auto max-w-7xl px-6 py-24">
      <div class="fade-in-section">
        <div class="max-w-4xl mb-16">
          <div class="text-xs uppercase tracking-[0.2em] text-gray-500 mb-6">
            Chapitre 01
          </div>
          <h2 class="text-4xl md:text-6xl font-serif mb-6 text-[#111111]">
            Accessibilité culturelle physique et numérique
          </h2>
          <p class="text-lg text-gray-700 leading-relaxed max-w-3xl">
            Tout d'abord, il est important de comprendre les stratégies
            respectives de ces deux métropoles. Pour cela, nous comparons le
            nombre d'habitants par lieu culturel et offre numérique proposée
            dans chaque ville, ce qui permet de visualiser la densité d'accès.
          </p>
        </div>

        <div class="grid lg:grid-cols-2 gap-12 items-start mb-16">
          <div class="bg-white rounded-2xl p-8 shadow-sm">
            <div class="mb-6">
              <label class="text-sm font-semibold text-[#111111] mb-3 block">
                Type d'offre à afficher :
              </label>
              <div class="flex gap-4">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="radio"
                    name="choixType"
                    value="physique"
                    checked
                    class="radio radio-sm radio-primary"
                  />
                  <span class="text-gray-700">Physique</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="radio"
                    name="choixType"
                    value="numérique"
                    class="radio radio-sm radio-primary"
                  />
                  <span class="text-gray-700">Numérique</span>
                </label>
              </div>
            </div>
            <div id="chart-container"></div>
          </div>

          <div class="space-y-8">
            <div>
              <h3 class="text-2xl md:text-3xl font-serif text-[#111111] mb-4">
                Montpellier, une stratégie tournée vers l'avenir
              </h3>
              <p class="text-lg text-gray-700 leading-relaxed mb-4">
                À travers ces résultats, on observe clairement le positionnement
                de Montpellier comme la ville explorant les nouvelles formes de
                médiation numérique, avec <span
                  class="text-[#F77F00] font-semibold"
                  >44 273 habitants par offre numérique</span
                > contre <span class="text-[#0077B6] font-semibold"
                  >84 833 pour Bordeaux</span
                >.
              </p>
              <p class="text-lg text-gray-700 leading-relaxed">
                Montpellier offre une densité d'accès à l'innovation presque
                deux fois supérieure à celle de Bordeaux. Cela traduit un
                investissement fort visant à rapprocher l'offre culturelle
                immatérielle de ses habitants, faisant d'elle la leader de
                l'accessibilité culturelle numérique dans cette comparaison.
              </p>
            </div>

            <div>
              <h3 class="text-2xl md:text-3xl font-serif text-[#111111] mb-4">
                Bordeaux, ancrage dans le patrimoine plus classique
              </h3>
              <p class="text-lg text-gray-700 leading-relaxed mb-4">
                À l'inverse, Bordeaux maintient une forte accessibilité à ses
                lieux culturels, avec <span class="text-[#0077B6] font-semibold"
                  >1 647 habitants par lieu culturel physique</span
                >. Bien que légèrement moins dense que Montpellier (1 517),
                cette donnée montre un maillage du territoire relativement fort.
              </p>
              <p class="text-lg text-gray-700 leading-relaxed">
                C'est le contraste avec le numérique qui révèle la stratégie de
                Bordeaux : le fossé avec le numérique est colossal. En effet,
                l'offre numérique est <span class="font-semibold text-[#111111]"
                  >51,5 fois moins accessible</span
                > que l'offre physique ; inversement, pour Montpellier, l'offre numérique
                est <span class="font-semibold text-[#111111]"
                  >29,2 fois moins accessible</span
                > que l'offre physique.
              </p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-2xl p-8 border-l-4 border-[#111111]">
          <p class="text-xl text-gray-700 leading-relaxed italic">
            En somme, <span class="font-semibold text-[#0077B6]">Bordeaux</span>
            cherche la réinvention en consolidant son patrimoine, l'offre physique
            étant prioritaire, tandis que <span
              class="font-semibold text-[#F77F00]">Montpellier</span
            > cherche la réinvention en privilégiant le partage de la culture par
            le biais du numérique.
          </p>
        </div>
      </div>
    </div>
  </section>

  <section
    id="chapitre-02"
    class="snap-section bg-[#F2F2F2] min-h-screen flex items-center"
  >
    <div class="container mx-auto max-w-7xl px-6 py-24">
      <div class="fade-in-section">
        <div class="max-w-5xl mb-16">
          <div class="text-xs uppercase tracking-[0.2em] text-gray-500 mb-6">
            Chapitre 02
          </div>
          <h2 class="text-4xl md:text-6xl font-serif mb-6 text-[#111111]">
            Cartographie de l'offre culturelle
          </h2>
          <p class="text-lg text-gray-700 leading-relaxed mb-4">
            Après avoir analysé l'accessibilité globale, plongeons dans la
            répartition géographique des équipements culturels. Ces cartes
            interactives permettent de visualiser précisément où se concentrent
            les lieux culturels physiques et les initiatives numériques dans
            chaque métropole.
          </p>
          <p class="text-lg text-gray-700 leading-relaxed">
            Utilisez les filtres pour explorer les différents types
            d'équipements et d'offres, révélant ainsi les dynamiques
            territoriales de chaque ville.
          </p>
        </div>

        <div class="flex justify-center mb-8">
          <div class="bg-white rounded-xl p-2 shadow-sm inline-flex gap-2">
            <button
              id="btn-leaflet"
              class="px-6 py-3 rounded-lg text-sm font-semibold transition-all duration-300 bg-[#111111] text-white"
            >
              Vue Interactive
            </button>
            <button
              id="btn-geojson"
              class="px-6 py-3 rounded-lg text-sm font-semibold transition-all duration-300 text-gray-700 hover:bg-gray-100"
            >
              Vue Géographique
            </button>
          </div>
        </div>

        <div id="leaflet-container" class="grid lg:grid-cols-2 gap-8 mb-8">
          <div>
            <h3 class="text-2xl font-serif text-[#0077B6] mb-4">Bordeaux</h3>

            <div class="grid grid-cols-2 gap-4 mb-6">
              <div>
                <label class="text-sm font-semibold text-[#111111] mb-2 block">
                  Type d'offre :
                </label>
                <select
                  id="filtreTypeOffreBdx"
                  class="select select-bordered w-full bg-white text-gray-700"
                >
                  <option value="Toutes">Toutes les offres</option>
                  <option value="physique">Physique</option>
                  <option value="numérique">Numérique</option>
                </select>
              </div>

              <div>
                <label class="text-sm font-semibold text-[#111111] mb-2 block">
                  Type d'équipement :
                </label>
                <select
                  id="filtreEquipementBdx"
                  class="select select-bordered w-full bg-white text-gray-700"
                >
                  <option value="Tous">Tous les équipements</option>
                </select>
              </div>
            </div>

            <div
              id="map-bordeaux"
              class="w-full h-[600px] rounded-xl shadow-lg"
            >
            </div>
          </div>

          <div>
            <h3 class="text-2xl font-serif text-[#F77F00] mb-4">Montpellier</h3>

            <div class="grid grid-cols-2 gap-4 mb-6">
              <div>
                <label class="text-sm font-semibold text-[#111111] mb-2 block">
                  Type d'offre :
                </label>
                <select
                  id="filtreTypeOffreMtp"
                  class="select select-bordered w-full bg-white text-gray-700"
                >
                  <option value="Toutes">Toutes les offres</option>
                  <option value="physique">Physique</option>
                  <option value="numérique">Numérique</option>
                </select>
              </div>

              <div>
                <label class="text-sm font-semibold text-[#111111] mb-2 block">
                  Type d'équipement :
                </label>
                <select
                  id="filtreEquipementMtp"
                  class="select select-bordered w-full bg-white text-gray-700"
                >
                  <option value="Tous">Tous les équipements</option>
                </select>
              </div>
            </div>

            <div
              id="map-montpellier"
              class="w-full h-[600px] rounded-xl shadow-lg"
            >
            </div>
          </div>
        </div>

        <div id="geojson-container" class="hidden">
          <div class="mb-6 flex justify-center">
            <div class="inline-flex flex-col gap-2">
              <label class="text-sm font-semibold text-[#111111]">
                Type d'équipement :
              </label>
              <select
                id="filtreEquipementGeo"
                class="select select-bordered bg-white text-gray-700"
              >
                <option value="Toutes">Toutes les offres</option>
              </select>
            </div>
          </div>

          <div class="grid lg:grid-cols-2 gap-8 mb-8">
            <div>
              <h3 class="text-2xl font-serif text-[#0077B6] mb-4">Bordeaux</h3>
              <div id="geo-bordeaux" class="w-full rounded-xl"></div>
            </div>

            <div>
              <h3 class="text-2xl font-serif text-[#F77F00] mb-4">
                Montpellier
              </h3>
              <div id="geo-montpellier" class="w-full rounded-xl"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section
    id="chapitre-03"
    class="snap-section bg-[#F2F2F2] min-h-screen flex items-center"
  >
    <div class="container mx-auto max-w-7xl px-6 py-24">
      <div class="fade-in-section">
        <div class="max-w-5xl mb-16">
          <div class="text-xs uppercase tracking-[0.2em] text-gray-500 mb-6">
            Chapitre 03
          </div>
          <h2 class="text-4xl md:text-6xl font-serif mb-6 text-[#111111]">
            Top 10 des équipements culturels
          </h2>
          <p class="text-lg text-gray-700 leading-relaxed">
            Après avoir établi la densité globale et la répartition spatiale de
            l'offre, il est crucial de comprendre ce qui compose réellement
            l'offre physique de Bordeaux et Montpellier. Cette troisième
            visualisation nous permet de passer à la structure même du
            patrimoine culturel. En comparant le nombre d'équipements dans les
            dix catégories principales, nous pouvons déterminer les domaines
            d'investissement culturels prioritaires de chaque métropole.
          </p>
        </div>

        <div class="bg-white rounded-2xl p-8 shadow-sm mb-12">
          <PlotFigure
            options={{
              title: "Top 10 des équipements culturels (2025)",
              subtitle:
                "Comparaison Bordeaux vs Montpellier — Équipements avec minimum 3 lieux",
              marginLeft: 180,
              marginRight: 220,
              marginBottom: 70,
              marginTop: 90,
              width: 1200,
              height: 480,
              style: {
                background: "linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%)",
                fontSize: 14,
                fontFamily: "Inter, system-ui, -apple-system, sans-serif",
                color: "#1a1a1a",
              },
              x: {
                label:
                  "← Bordeaux                                    Montpellier →",
                labelAnchor: "center",
                labelOffset: 45,
                tickFormat: (d) => Math.abs(d),
                grid: true,
                nice: true,
                line: true,
                domain: [
                  -Math.min(
                    150,
                    Math.max(
                      ...butterflyData
                        .filter((d) => d.ville === "Bordeaux")
                        .map((d) => Math.abs(d.count))
                    ) * 1.1
                  ),
                  Math.min(
                    150,
                    Math.max(
                      ...butterflyData
                        .filter((d) => d.ville === "Montpellier")
                        .map((d) => d.count)
                    ) * 1.1
                  ),
                ],
                clamp: true,
              },
              y: {
                label: null,
                domain: equipementsDomain,
                tickSize: 0,
                tickPadding: 12,
                fontSize: 13,
              },
              color: {
                domain: ["Bordeaux", "Montpellier"],
                range: [colors.Bordeaux, colors.Montpellier],
                legend: true,
                label: "Ville",
                marginLeft: 100,
              },
              marks: [
                Plot.barX(butterflyData, {
                  x: "count",
                  y: "type",
                  fill: "ville",
                  insetTop: 3,
                  insetBottom: 3,
                  rx: 6,
                  tip: true,
                  title: (d) =>
                    `${d.ville}\n${d.type}\n${d.countAbs} équipement${
                      d.countAbs > 1 ? "s" : ""
                    }`,
                }),
                Plot.ruleX([0], {
                  stroke: "#1a1a1a",
                  strokeWidth: 3,
                }),
                Plot.text(
                  butterflyData.filter(
                    (d) => d.ville === "Bordeaux" && d.countAbs > 0
                  ),
                  {
                    x: (d) => Math.max(d.count, -150),
                    y: "type",
                    text: (d) => d.countAbs.toString(),
                    dx: -12,
                    fill: "#ffffff",
                    fontSize: 12,
                    fontWeight: "700",
                  }
                ),
                Plot.text(
                  butterflyData.filter(
                    (d) => d.ville === "Montpellier" && d.countAbs > 0
                  ),
                  {
                    x: (d) => Math.min(d.count, 150),
                    y: "type",
                    text: (d) => d.countAbs.toString(),
                    dx: 12,
                    fill: "#ffffff",
                    fontSize: 12,
                    fontWeight: "700",
                  }
                ),
                Plot.text(
                  equipementsDomain.map((type) => {
                    const dataType = butterflyData.filter(
                      (d) => d.type === type
                    );
                    const bordeaux =
                      dataType.find((d) => d.ville === "Bordeaux")?.countAbs ||
                      0;
                    const montpellier =
                      dataType.find((d) => d.ville === "Montpellier")
                        ?.countAbs || 0;
                    const total = bordeaux + montpellier;
                    return {
                      type,
                      total,
                      label: `Total: ${total}`,
                    };
                  }),
                  {
                    x: 150,
                    y: "type",
                    text: "label",
                    dx: 55,
                    textAnchor: "start",
                    fill: "#495057",
                    fontSize: 12,
                    fontWeight: "700",
                    stroke: "#ffffff",
                    strokeWidth: 2,
                    paintOrder: "stroke",
                  }
                ),
              ],
            }}
          />
        </div>

        <div class="bg-white rounded-2xl p-8 border-l-4 border-[#111111]">
          <p class="text-lg text-gray-700 leading-relaxed">
            Ce graphique révèle les forces historiques des deux villes et met en
            lumière les secteurs qui soutiennent l'accessibilité physique
            observée précédemment. L'analyse de la structure de l'offre physique
            renforce l'idée que les deux villes, en particulier Bordeaux,
            s'appuient fortement sur leur héritage patrimonial, mais avec des
            différences notables dans la manière dont cette offre est maillée.
          </p>
        </div>
      </div>
    </div>
  </section>

  <section
    id="chapitre-04"
    class="snap-section bg-[#F2F2F2] min-h-screen flex items-center"
  >
    <div class="container mx-auto max-w-7xl px-6 py-24">
      <div class="fade-in-section">
        <div class="max-w-5xl mb-16 text-right ml-auto">
          <div class="text-xs uppercase tracking-[0.2em] text-gray-500 mb-6">
            Chapitre 04
          </div>
          <h2 class="text-4xl md:text-6xl font-serif mb-6 text-[#111111]">
            Profils culturels multidimensionnels
          </h2>
          <p class="text-lg text-gray-700 leading-relaxed">
            Au-delà des simples chiffres d'accessibilité et de la structure de
            l'offre, il est essentiel d'adopter une vision systémique pour
            comprendre le positionnement culturel global de chaque métropole. Ce
            radar chart synthétise six dimensions clés : patrimoine,
            bibliothèques, festivals, innovation numérique, accessibilité
            physique et diversité des équipements.
          </p>
        </div>

        <div class="grid lg:grid-cols-2 gap-12 items-start mb-16">
          <div class="space-y-8">
            <div>
              <h3 class="text-2xl md:text-3xl font-serif text-[#111111] mb-4">
                Bordeaux : la puissance patrimoniale
              </h3>
              <p class="text-lg text-gray-700 leading-relaxed mb-4">
                Le profil de Bordeaux révèle une domination écrasante dans la
                dimension <span class="text-[#0077B6] font-semibold"
                  >patrimoine</span
                >, avec une densité de musées et monuments exceptionnelle pour
                100 000 habitants. Cette force historique est au cœur de son
                identité UNESCO et de sa stratégie culturelle.
              </p>
              <p class="text-lg text-gray-700 leading-relaxed">
                En revanche, le radar expose clairement les limites de Bordeaux
                en matière d'<span class="font-semibold text-[#111111]"
                  >innovation numérique</span
                > et de <span class="font-semibold text-[#111111]"
                  >festivals</span
                >, confirmant ainsi une approche culturelle plus traditionnelle
                et patrimoniale.
              </p>
            </div>

            <div>
              <h3 class="text-2xl md:text-3xl font-serif text-[#111111] mb-4">
                Montpellier : l'équilibre moderne
              </h3>
              <p class="text-lg text-gray-700 leading-relaxed mb-4">
                Le profil de Montpellier se distingue par son <span
                  class="font-semibold text-[#111111]">équilibre</span
                > entre les dimensions. Si la ville n'écrase pas sur une seule catégorie
                comme Bordeaux, elle compense par une offre <span
                  class="text-[#F77F00] font-semibold">diversifiée</span
                > et une forte présence dans les festivals et l'innovation numérique.
              </p>
              <p class="text-lg text-gray-700 leading-relaxed">
                Ce profil harmonieux traduit une stratégie culturelle plus <span
                  class="font-semibold text-[#111111]"
                  >inclusive et tournée vers l'avenir</span
                >, privilégiant la diversité des expériences culturelles plutôt
                que la concentration sur un seul domaine d'excellence.
              </p>
            </div>
          </div>

          <div class="bg-white rounded-2xl p-8 shadow-sm">
            <PlotFigure
              options={{
                title: "Profils culturels comparés (2025)",
                subtitle:
                  "Radar Chart — Bordeaux vs Montpellier sur 6 dimensions culturelles",
                width: 560,
                height: 600,
                margin: 80,
                marginBottom: 100,
                style: {
                  background:
                    "linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%)",
                  fontSize: 13,
                  fontFamily: "Inter, system-ui, -apple-system, sans-serif",
                  color: "#1a1a1a",
                },
                projection: {
                  type: "identity",
                  domain: {
                    type: "MultiPoint",
                    coordinates: [
                      [-120, -120],
                      [120, 120],
                    ],
                  },
                },
                marks: [
                  ...[0, 20, 40, 60, 80, 100].map((r) =>
                    Plot.circle([{ x: 0, y: 0 }], {
                      x: "x",
                      y: "y",
                      r: r * 1.1,
                      stroke: "#dee2e6",
                      strokeWidth: r === 100 ? 2 : 1,
                      strokeDasharray: r === 100 ? "none" : "4,4",
                      fill: "none",
                    })
                  ),
                  Plot.link(
                    radarData.filter((d) => d.ville === "Bordeaux"),
                    {
                      x1: 0,
                      y1: 0,
                      x2: (d) => 110 * Math.cos(d.angle),
                      y2: (d) => 110 * Math.sin(d.angle),
                      stroke: "#adb5bd",
                      strokeWidth: 1,
                    }
                  ),
                  Plot.text(
                    radarData.filter((d) => d.ville === "Bordeaux"),
                    {
                      x: (d) => 125 * Math.cos(d.angle),
                      y: (d) => 125 * Math.sin(d.angle),
                      text: "dimension",
                      fontSize: 11,
                      fontWeight: "600",
                      fill: "#495057",
                      textAnchor: "middle",
                      lineWidth: 12,
                      lineHeight: 1.2,
                    }
                  ),
                  Plot.line(
                    radarData
                      .filter((d) => d.ville === "Bordeaux")
                      .sort((a, b) => a.index - b.index)
                      .concat([
                        radarData.find(
                          (d) => d.ville === "Bordeaux" && d.index === 0
                        ),
                      ]),
                    {
                      x: (d) => d.value * 1.1 * Math.cos(d.angle),
                      y: (d) => d.value * 1.1 * Math.sin(d.angle),
                      stroke: colors.Bordeaux,
                      strokeWidth: 0,
                      fill: colors.Bordeaux,
                      fillOpacity: 0.25,
                      curve: "linear-closed",
                    }
                  ),
                  Plot.line(
                    radarData
                      .filter((d) => d.ville === "Montpellier")
                      .sort((a, b) => a.index - b.index)
                      .concat([
                        radarData.find(
                          (d) => d.ville === "Montpellier" && d.index === 0
                        ),
                      ]),
                    {
                      x: (d) => d.value * 1.1 * Math.cos(d.angle),
                      y: (d) => d.value * 1.1 * Math.sin(d.angle),
                      stroke: colors.Montpellier,
                      strokeWidth: 0,
                      fill: colors.Montpellier,
                      fillOpacity: 0.25,
                      curve: "linear-closed",
                    }
                  ),
                  Plot.line(
                    radarData
                      .filter((d) => d.ville === "Bordeaux")
                      .sort((a, b) => a.index - b.index)
                      .concat([
                        radarData.find(
                          (d) => d.ville === "Bordeaux" && d.index === 0
                        ),
                      ]),
                    {
                      x: (d) => d.value * 1.1 * Math.cos(d.angle),
                      y: (d) => d.value * 1.1 * Math.sin(d.angle),
                      stroke: colors.Bordeaux,
                      strokeWidth: 3,
                      curve: "linear-closed",
                    }
                  ),
                  Plot.line(
                    radarData
                      .filter((d) => d.ville === "Montpellier")
                      .sort((a, b) => a.index - b.index)
                      .concat([
                        radarData.find(
                          (d) => d.ville === "Montpellier" && d.index === 0
                        ),
                      ]),
                    {
                      x: (d) => d.value * 1.1 * Math.cos(d.angle),
                      y: (d) => d.value * 1.1 * Math.sin(d.angle),
                      stroke: colors.Montpellier,
                      strokeWidth: 3,
                      curve: "linear-closed",
                    }
                  ),
                  Plot.dot(radarData, {
                    x: (d) => d.value * 1.1 * Math.cos(d.angle),
                    y: (d) => d.value * 1.1 * Math.sin(d.angle),
                    r: 5,
                    fill: (d) => colors[d.ville],
                    stroke: "#ffffff",
                    strokeWidth: 2,
                    tip: true,
                    title: (d) =>
                      `${d.ville}\n${d.dimension.replace(/\n/g, " ")}\nValeur: ${d.rawValue.toFixed(2)}`,
                  }),
                  Plot.text(radarData, {
                    x: (d) => (d.value * 1.1 - 10) * Math.cos(d.angle),
                    y: (d) => (d.value * 1.1 - 10) * Math.sin(d.angle),
                    text: (d) => d.rawValue.toFixed(1),
                    fill: (d) => colors[d.ville],
                    fontSize: 10,
                    fontWeight: "700",
                    stroke: "#ffffff",
                    strokeWidth: 2.5,
                    paintOrder: "stroke",
                    textAnchor: "middle",
                  }),
                ],
              }}
            />
          </div>
        </div>

        <div class="bg-white rounded-2xl p-8 border-l-4 border-[#111111]">
          <p class="text-xl text-gray-700 leading-relaxed italic">
            Cette analyse multidimensionnelle confirme que <span
              class="font-semibold text-[#0077B6]">Bordeaux</span
            > et <span class="font-semibold text-[#F77F00]">Montpellier</span> poursuivent
            deux modèles culturels distincts : l'une mise sur l'excellence patrimoniale
            et la profondeur historique, l'autre privilégie la diversité et l'innovation
            contemporaine.
          </p>
        </div>
      </div>
    </div>
  </section>

  <section
    id="conclusion"
    class="snap-section bg-[#F2F2F2] min-h-screen flex items-center"
  >
    <div class="container mx-auto max-w-4xl px-6 py-24">
      <div class="space-y-8 fade-in-section">
        <div class="text-xs uppercase tracking-[0.3em] text-gray-500">
          Conclusion
        </div>

        <h2
          class="text-4xl md:text-5xl lg:text-6xl font-serif text-[#111111] leading-tight"
        >
          Deux visions, un même territoire
        </h2>

        <div class="prose prose-lg max-w-none">
          <p class="text-xl text-gray-700 leading-relaxed mb-6">
            À travers cette exploration comparative, une réalité s'impose : <span
              class="font-semibold text-[#111111]"
              >Bordeaux et Montpellier incarnent deux modèles culturels
              complémentaires</span
            > qui répondent chacun à des enjeux différents du territoire français.
          </p>

          <p class="text-xl text-gray-700 leading-relaxed mb-6">
            <span class="text-[#0077B6] font-semibold">Bordeaux</span>, forte de
            ses 407 monuments classés et de son statut UNESCO, a fait le choix
            stratégique de capitaliser sur son <span
              class="font-semibold text-[#111111]"
              >héritage patrimonial exceptionnel</span
            >. Cette approche se traduit par une densité remarquable
            d'équipements culturels physiques (1 647 habitants par lieu),
            positionnant la ville comme un conservatoire vivant du patrimoine
            français. Toutefois, cette excellence historique s'accompagne d'un
            retard notable dans la transition numérique, avec une offre digitale
            51,5 fois moins accessible que son offre physique.
          </p>

          <p class="text-xl text-gray-700 leading-relaxed mb-6">
            <span class="text-[#F77F00] font-semibold">Montpellier</span>, de
            son côté, propose un modèle radicalement différent. Avec 51
            festivals et une innovation numérique deux fois plus accessible que
            Bordeaux, la métropole méditerranéenne mise sur la <span
              class="font-semibold text-[#111111]"
              >diversité, la jeunesse et l'expérimentation</span
            >. Son profil culturel plus équilibré traduit une volonté
            d'ouverture et d'adaptation aux nouveaux modes de consommation
            culturelle, faisant d'elle un laboratoire de la culture
            contemporaine.
          </p>

          <p class="text-xl text-gray-700 leading-relaxed">
            Ces deux trajectoires ne sont pas antagonistes mais <span
              class="font-semibold text-[#111111]">complémentaires</span
            >. Elles illustrent la richesse du paysage culturel français,
            capable de conjuguer préservation patrimoniale et innovation
            numérique, profondeur historique et dynamisme événementiel. Dans un
            contexte de transformation digitale accélérée, la question n'est
            plus de savoir quel modèle l'emporte, mais comment ces deux visions
            peuvent s'enrichir mutuellement pour construire la culture de
            demain.
          </p>
        </div>

        <div class="grid md:grid-cols-2 gap-6 mt-12">
          <div
            class="bg-gradient-to-br from-[#0077B6]/5 to-[#0077B6]/10 rounded-2xl p-8 border-l-4 border-[#0077B6]"
          >
            <h3 class="text-2xl font-serif text-[#111111] mb-4">Bordeaux</h3>
            <p class="text-gray-700 leading-relaxed text-lg">
              L'excellence patrimoniale comme pilier d'une identité culturelle
              forte et d'un rayonnement international.
            </p>
          </div>

          <div
            class="bg-gradient-to-br from-[#F77F00]/5 to-[#F77F00]/10 rounded-2xl p-8 border-l-4 border-[#F77F00]"
          >
            <h3 class="text-2xl font-serif text-[#111111] mb-4">Montpellier</h3>
            <p class="text-gray-700 leading-relaxed text-lg">
              La diversité et l'innovation comme moteurs d'une culture
              accessible et tournée vers l'avenir.
            </p>
          </div>
        </div>
      </div>

      <div class="text-center mt-12">
        <a
          href="#"
          class="inline-flex items-center gap-2 text-sm uppercase tracking-wider text-gray-500 hover:text-[#111111] transition-colors"
        >
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
          </svg>
          Retour en haut
        </a>
      </div>
    </div>
  </section>
</Layout>

<div
  id="progress-indicator"
  class="fixed right-8 top-1/2 -translate-y-1/2 z-50 hidden md:flex flex-col gap-3 opacity-0 transition-opacity duration-500"
>
  <a
    href="#intro"
    class="progress-dot w-2 h-2 rounded-full bg-black/30 hover:bg-black/60 transition-all duration-300"
    data-section="0"></a>
  <a
    href="#chapitre-01"
    class="progress-dot w-2 h-2 rounded-full bg-black/30 hover:bg-black/60 transition-all duration-300"
    data-section="1"></a>
  <a
    href="#chapitre-02"
    class="progress-dot w-2 h-2 rounded-full bg-black/30 hover:bg-black/60 transition-all duration-300"
    data-section="2"></a>
  <a
    href="#chapitre-03"
    class="progress-dot w-2 h-2 rounded-full bg-black/30 hover:bg-black/60 transition-all duration-300"
    data-section="3"></a>
  <a
    href="#chapitre-04"
    class="progress-dot w-2 h-2 rounded-full bg-black/30 hover:bg-black/60 transition-all duration-300"
    data-section="4"></a>
  <a
    href="#conclusion"
    class="progress-dot w-2 h-2 rounded-full bg-black/30 hover:bg-black/60 transition-all duration-300"
    data-section="5"></a>
</div>

<style>
  :global(html) {
    scroll-behavior: smooth;
  }

  .snap-section {
  }

  .fade-in-section {
    opacity: 0;
    transform: translateY(40px);
    transition:
      opacity 1.2s cubic-bezier(0.4, 0, 0.2, 1),
      transform 1.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .fade-in-section.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .progress-dot.active {
    background-color: #111111;
    width: 0.75rem;
    height: 0.75rem;
  }

  .prose p {
    margin-bottom: 1.5rem;
  }

  @media (prefers-reduced-motion: reduce) {
    :global(html) {
      scroll-behavior: auto;
    }

    .fade-in-section {
      transition: none;
      opacity: 1;
      transform: none;
    }
  }
</style>

<script>
  declare global {
    interface Window {
      Plot: any;
      d3: any;
      L: any;
    }
  }

  const observerOptions = {
    threshold: 0.2,
    rootMargin: "0px 0px -10% 0px",
  };

  const fadeObserver = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        entry.target.classList.add("visible");
      }
    });
  }, observerOptions);

  document.querySelectorAll(".fade-in-section").forEach((section) => {
    fadeObserver.observe(section);
  });

  const storytellingSections = [
    document.getElementById("intro"),
    document.getElementById("chapitre-01"),
    document.getElementById("chapitre-02"),
    document.getElementById("chapitre-03"),
    document.getElementById("chapitre-04"),
    document.getElementById("conclusion"),
  ];
  const progressIndicator = document.getElementById("progress-indicator");
  const progressDots = document.querySelectorAll(".progress-dot");

  const sectionObserver = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const index = storytellingSections.indexOf(
            entry.target as HTMLElement
          );
          if (index !== -1) {
            progressDots.forEach((dot, i) => {
              if (i === index) {
                dot.classList.add("active");
              } else {
                dot.classList.remove("active");
              }
            });
          }
        }
      });
    },
    { threshold: 0.5 }
  );

  storytellingSections.forEach((section) => {
    if (section) sectionObserver.observe(section);
  });

  const heroSection = document.querySelector(".snap-section");
  const heroObserver = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          progressIndicator?.classList.add("opacity-0");
        } else {
          progressIndicator?.classList.remove("opacity-0");
        }
      });
    },
    { threshold: 0.3 }
  );

  if (heroSection) heroObserver.observe(heroSection);

  const LieuxParVilleTypeData = JSON.parse(
    document.getElementById("data-lieux")?.textContent || "[]"
  );

  const colors = {
    Bordeaux: "#0077B6",
    Montpellier: "#F77F00",
  };

  function renderChart(choixType) {
    const container = document.getElementById("chart-container");
    if (!container || !window.Plot) return;

    container.innerHTML = "";

    const filteredData = LieuxParVilleTypeData.filter(
      (d) => d.type_offre === choixType
    );

    const plot = window.Plot.plot({
      title: "Accessibilité culturelle selon le type d'offre (2025)",
      subtitle: `Nombre d'habitants par ${
        choixType === "physique" ? "lieu culturel physique" : "offre numérique"
      } — Bordeaux vs Montpellier`,
      height: 480,
      marginLeft: 100,
      marginBottom: 70,
      marginTop: 80,
      width: 560,
      style: {
        background: "linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%)",
        fontSize: "14px",
        fontFamily: "Inter, system-ui, -apple-system, sans-serif",
        color: "#111111",
      },
      x: {
        label: "Ville",
        domain: ["Bordeaux", "Montpellier"],
        tickSize: 0,
      },
      y: {
        grid: true,
        label:
          choixType === "physique"
            ? "↑ Habitants par offre culturelle physique"
            : "↑ Habitants par offre culturelle numérique",
        labelAnchor: "top",
        labelOffset: 40,
        tickFormat: "~s",
      },
      color: {
        domain: ["Bordeaux", "Montpellier"],
        range: [colors.Bordeaux, colors.Montpellier],
        legend: true,
        label: "Ville",
      },
      marks: [
        window.Plot.ruleY([0], { stroke: "#333", strokeWidth: 1.5 }),
        window.Plot.barY(filteredData, {
          x: "ville",
          y: "habitants_par_lieu",
          fill: "ville",
          rx: 8,
          tip: {
            fill: "#ffffff",
            stroke: (d) =>
              d.ville === "Bordeaux" ? colors.Bordeaux : colors.Montpellier,
            strokeWidth: 3,
            fontSize: "14px",
          },
          title: (d) =>
            `${d.ville} — ${
              d.type_offre === "physique" ? "Offre physique" : "Offre numérique"
            }\n\n${d.habitants_par_lieu
              ?.toFixed(0)
              .replace(/\B(?=(\d{3})+(?!\d))/g, " ")} habitants/${
              d.type_offre === "physique" ? "lieu" : "offre"
            }\n${d.lieux} ${d.type_offre === "physique" ? "lieu" : "offre"}${
              d.lieux > 1 ? "s" : ""
            }`,
        }),
        window.Plot.text(filteredData, {
          x: "ville",
          y: (d) => d.habitants_par_lieu + d.habitants_par_lieu * 0.04,
          text: (d) => d.habitants_par_lieu.toLocaleString("fr-FR"),
          textAnchor: "middle",
          fill: "#111111",
          fontSize: 18,
          fontWeight: "700",
          stroke: "#ffffff",
          strokeWidth: 3,
          paintOrder: "stroke",
        }),
        window.Plot.text(filteredData, {
          x: "ville",
          y: (d) => d.habitants_par_lieu * 0.5,
          text: (d) =>
            `${d.lieux} ${choixType === "physique" ? "lieu" : "offre"}${
              d.lieux > 1 ? (choixType === "physique" ? "x" : "s") : ""
            }`,
          textAnchor: "middle",
          fill: "#ffffff",
          fontSize: 15,
          fontWeight: "600",
          opacity: 0.95,
        }),
      ],
    });

    container.appendChild(plot);
  }

  const radioInputs = document.querySelectorAll('input[name="choixType"]');
  radioInputs.forEach((input) => {
    input.addEventListener("change", (e) => {
      renderChart((e.target as HTMLInputElement).value);
    });
  });

  function initChart() {
    if (window.Plot) {
      renderChart("physique");
    } else {
      setTimeout(initChart, 100);
    }
  }

  initChart();

  // ========== LEAFLET MAPS INITIALIZATION ==========
  let mapBordeaux = null;
  let mapMontpellier = null;
  let dataBordeaux = [];
  let dataMontpellier = [];
  let mapsInitialized = false;

  async function loadData() {
    try {
      const response = await fetch("/src/assets/DataCulturelles2025.json");
      const data = await response.json();

      dataBordeaux = data.filter((d) => d.ville?.toLowerCase() === "bordeaux");
      dataMontpellier = data.filter(
        (d) => d.ville?.toLowerCase() === "montpellier"
      );

      // Populate equipment selects
      const equipmentsBdx = [
        ...new Set(dataBordeaux.map((d) => d.type_equipement)),
      ]
        .filter(Boolean)
        .sort();
      const equipmentsMtp = [
        ...new Set(dataMontpellier.map((d) => d.type_equipement)),
      ]
        .filter(Boolean)
        .sort();

      const selectBdx = document.getElementById("filtreEquipementBdx");
      const selectMtp = document.getElementById("filtreEquipementMtp");

      equipmentsBdx.forEach((eq) => {
        const option = document.createElement("option");
        option.value = eq;
        option.textContent = eq;
        selectBdx.appendChild(option);
      });

      equipmentsMtp.forEach((eq) => {
        const option = document.createElement("option");
        option.value = eq;
        option.textContent = eq;
        selectMtp.appendChild(option);
      });

      return true;
    } catch (error) {
      console.error("Error loading data:", error);
      return false;
    }
  }

  function createIcon(typeOffre) {
    const color = typeOffre === "numérique" ? "#F77F00" : "#0077B6";
    const size = typeOffre === "numérique" ? 20 : 16;
    return window.L.divIcon({
      className: "custom-icon",
      html: `<div style="background-color: ${color}; width: ${size}px; height: ${size}px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 6px rgba(0,0,0,0.4);"></div>`,
      iconSize: [size, size],
      iconAnchor: [size / 2, size / 2],
    });
  }

  function initMapBordeaux() {
    if (!document.getElementById("map-bordeaux") || !window.L) return;

    mapBordeaux = window.L.map("map-bordeaux").setView([44.8378, -0.5792], 13);

    window.L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",
      {
        attribution: "© OpenStreetMap © CARTO",
        maxZoom: 19,
      }
    ).addTo(mapBordeaux);

    updateMapBordeaux();
  }

  function initMapMontpellier() {
    if (!document.getElementById("map-montpellier") || !window.L) return;

    mapMontpellier = window.L.map("map-montpellier").setView(
      [43.6109, 3.8767],
      13
    );

    window.L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",
      {
        attribution: "© OpenStreetMap © CARTO",
        maxZoom: 19,
      }
    ).addTo(mapMontpellier);

    updateMapMontpellier();
  }

  function updateMapBordeaux() {
    if (!mapBordeaux) return;

    mapBordeaux.eachLayer((layer) => {
      if (layer instanceof window.L.Marker) {
        mapBordeaux.removeLayer(layer);
      }
    });

    const typeOffre = (
      document.getElementById("filtreTypeOffreBdx") as HTMLSelectElement
    ).value;
    const typeEquipement = (
      document.getElementById("filtreEquipementBdx") as HTMLSelectElement
    ).value;

    let filtered = dataBordeaux;
    if (typeOffre !== "Toutes") {
      filtered = filtered.filter((d) => d.type_offre === typeOffre);
    }
    if (typeEquipement !== "Tous") {
      filtered = filtered.filter((d) => d.type_equipement === typeEquipement);
    }

    filtered.forEach((d) => {
      if (d.latitude && d.longitude) {
        const icon = createIcon(d.type_offre);
        const popupContent = `
          <div style="font-family: Inter, sans-serif; max-width: 280px;">
            <h3 style="margin: 0 0 12px 0; color: #1a1a1a; font-size: 17px; font-weight: 600; border-bottom: 2px solid ${
              d.type_offre === "numérique" ? "#F77F00" : "#0077B6"
            }; padding-bottom: 8px;">
              ${d.nom}
            </h3>
            <p style="margin: 6px 0; color: #495057; font-size: 14px;">
              <strong>Type:</strong> ${d.type_equipement}
            </p>
            <p style="margin: 6px 0; color: #495057; font-size: 14px;">
              <strong>Adresse:</strong> ${d.adresse}
            </p>
          </div>
        `;

        window.L.marker([d.latitude, d.longitude], { icon })
          .bindPopup(popupContent)
          .addTo(mapBordeaux);
      }
    });
  }

  function updateMapMontpellier() {
    if (!mapMontpellier) return;

    mapMontpellier.eachLayer((layer) => {
      if (layer instanceof window.L.Marker) {
        mapMontpellier.removeLayer(layer);
      }
    });

    const typeOffre = (
      document.getElementById("filtreTypeOffreMtp") as HTMLSelectElement
    ).value;
    const typeEquipement = (
      document.getElementById("filtreEquipementMtp") as HTMLSelectElement
    ).value;

    let filtered = dataMontpellier;
    if (typeOffre !== "Toutes") {
      filtered = filtered.filter((d) => d.type_offre === typeOffre);
    }
    if (typeEquipement !== "Tous") {
      filtered = filtered.filter((d) => d.type_equipement === typeEquipement);
    }

    filtered.forEach((d) => {
      if (d.latitude && d.longitude) {
        const icon = createIcon(d.type_offre);
        const popupContent = `
          <div style="font-family: Inter, sans-serif; max-width: 280px;">
            <h3 style="margin: 0 0 12px 0; color: #1a1a1a; font-size: 17px; font-weight: 600; border-bottom: 2px solid ${
              d.type_offre === "numérique" ? "#F77F00" : "#0077B6"
            }; padding-bottom: 8px;">
              ${d.nom}
            </h3>
            <p style="margin: 6px 0; color: #495057; font-size: 14px;">
              <strong>Type:</strong> ${d.type_equipement}
            </p>
            <p style="margin: 6px 0; color: #495057; font-size: 14px;">
              <strong>Adresse:</strong> ${d.adresse}
            </p>
          </div>
        `;

        window.L.marker([d.latitude, d.longitude], { icon })
          .bindPopup(popupContent)
          .addTo(mapMontpellier);
      }
    });
  }

  async function initLeafletMaps() {
    if (mapsInitialized || !window.L) return;

    const dataLoaded = await loadData();
    if (!dataLoaded) return;

    initMapBordeaux();
    initMapMontpellier();

    document
      .getElementById("filtreTypeOffreBdx")
      ?.addEventListener("change", updateMapBordeaux);
    document
      .getElementById("filtreEquipementBdx")
      ?.addEventListener("change", updateMapBordeaux);
    document
      .getElementById("filtreTypeOffreMtp")
      ?.addEventListener("change", updateMapMontpellier);
    document
      .getElementById("filtreEquipementMtp")
      ?.addEventListener("change", updateMapMontpellier);

    mapsInitialized = true;
  }

  const chapitre02Observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting && !mapsInitialized) {
          setTimeout(() => initLeafletMaps(), 300);
        }
      });
    },
    { threshold: 0.1 }
  );

  const chapitre02 = document.getElementById("chapitre-02");
  if (chapitre02) {
    chapitre02Observer.observe(chapitre02);
  }

  // ========== GEOJSON / LEAFLET SWITCH ==========
  let currentMapMode = "leaflet";
  let geoMapsInitialized = false;
  let bordeauxGeoData: any = null;
  let montpellierGeoData: any = null;
  let dataBdxFull: any[] = [];
  let dataMtpFull: any[] = [];

  function loadGeoData() {
    try {
      bordeauxGeoData = JSON.parse(
        document.getElementById("data-bordeaux-geo")!.textContent || "{}"
      );
      montpellierGeoData = JSON.parse(
        document.getElementById("data-montpellier-geo")!.textContent || "{}"
      );
      dataBdxFull = JSON.parse(
        document.getElementById("data-bordeaux")!.textContent || "[]"
      );
      dataMtpFull = JSON.parse(
        document.getElementById("data-montpellier")!.textContent || "[]"
      );

      const equipmentsBdx = [
        ...new Set(dataBdxFull.map((d) => d.type_equipement)),
      ]
        .filter(Boolean)
        .sort();

      const selectGeo = document.getElementById(
        "filtreEquipementGeo"
      ) as HTMLSelectElement;
      equipmentsBdx.forEach((eq: string) => {
        const option = document.createElement("option");
        option.value = eq;
        option.textContent = eq;
        selectGeo?.appendChild(option);
      });

      return true;
    } catch (error) {
      console.error("Error loading geo data:", error);
      return false;
    }
  }

  function filterGeoData(data: any[], filterValue: string) {
    if (filterValue === "Toutes") {
      return data;
    }
    return data.filter((d) => d.type_equipement === filterValue);
  }

  function renderGeoBordeaux(filteredData: any[]) {
    if (!window.Plot || !window.d3) return;

    const container = document.getElementById("geo-bordeaux");
    if (!container) return;

    container.innerHTML = "";

    const plot = window.Plot.plot({
      projection: {
        type: "identity",
        domain: bordeauxGeoData,
      },
      width: 550,
      height: 680,
      marginTop: 90,
      marginBottom: 50,
      marginLeft: 20,
      marginRight: 20,
      style: {
        background: "linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)",
        fontFamily: "Inter, system-ui, -apple-system, sans-serif",
        color: "#1a1a1a",
      },
      title: "Accessibilité culturelle à Bordeaux",
      subtitle:
        "Répartition géographique des lieux et initiatives culturelles — physiques et numériques • 2025",
      color: {
        legend: true,
        label: "Type d'offre culturelle",
        domain: ["physique", "numérique"],
        range: ["#0077B6", "#F77F00"],
        tickFormat: (d: string) =>
          d === "physique" ? "Lieu physique" : "Initiative numérique",
        marginLeft: 40,
      },
      marks: [
        window.Plot.geo(bordeauxGeoData, {
          fill: "#ffffff",
          stroke: "#495057",
          strokeWidth: 1.2,
          strokeOpacity: 0.8,
        }),
        window.Plot.dot(filteredData, {
          x: "longitude",
          y: "latitude",
          r: (d: any) => (d.type_offre === "numérique" ? 7 : 5.5),
          fill: "#000000",
          opacity: 0.1,
          dx: 1,
          dy: 1,
        }),
        window.Plot.dot(filteredData, {
          x: "longitude",
          y: "latitude",
          r: (d: any) => (d.type_offre === "numérique" ? 6.5 : 5),
          fill: (d: any) => d.type_offre,
          stroke: "#ffffff",
          strokeWidth: 1.5,
          strokeOpacity: 0.9,
          opacity: 0.92,
          tip: true,
          title: (d: any) => {
            const base = `${d.nom}\n${d.type_equipement}\n${d.adresse}`;
            if (d.type_offre === "numérique" && d.type_initiative?.length) {
              return `${base}\n${d.type_initiative.join(", ")}`;
            }
            return base;
          },
        }),
      ],
    });

    container.appendChild(plot);
  }

  function renderGeoMontpellier(filteredData: any[]) {
    if (!window.Plot || !window.d3) return;

    const container = document.getElementById("geo-montpellier");
    if (!container) return;

    container.innerHTML = "";

    const plot = window.Plot.plot({
      projection: {
        type: "identity",
        domain: montpellierGeoData,
      },
      width: 550,
      height: 680,
      marginTop: 90,
      marginBottom: 50,
      marginLeft: 20,
      marginRight: 20,
      style: {
        background: "linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)",
        fontFamily: "Inter, system-ui, -apple-system, sans-serif",
        color: "#1a1a1a",
      },
      title: "Accessibilité culturelle à Montpellier",
      subtitle:
        "Répartition géographique des lieux et initiatives culturelles — physiques et numériques • 2025",
      color: {
        legend: true,
        label: "Type d'offre culturelle",
        domain: ["physique", "numérique"],
        range: ["#0077B6", "#F77F00"],
        tickFormat: (d: string) =>
          d === "physique" ? "Lieu physique" : "Initiative numérique",
        marginLeft: 40,
      },
      marks: [
        window.Plot.geo(montpellierGeoData, {
          fill: "#ffffff",
          stroke: "#495057",
          strokeWidth: 1.2,
          strokeOpacity: 0.8,
        }),
        window.Plot.dot(filteredData, {
          x: "longitude",
          y: "latitude",
          r: (d: any) => (d.type_offre === "numérique" ? 7 : 5.5),
          fill: "#000000",
          opacity: 0.1,
          dx: 1,
          dy: 1,
        }),
        window.Plot.dot(filteredData, {
          x: "longitude",
          y: "latitude",
          r: (d: any) => (d.type_offre === "numérique" ? 6.5 : 5),
          fill: (d: any) => d.type_offre,
          stroke: "#ffffff",
          strokeWidth: 1.5,
          strokeOpacity: 0.9,
          opacity: 0.92,
          tip: true,
          title: (d: any) => {
            const base = `${d.nom}\n${d.type_equipement}\n${d.adresse}`;
            if (d.type_offre === "numérique" && d.type_initiative?.length) {
              return `${base}\n${d.type_initiative.join(", ")}`;
            }
            return base;
          },
        }),
      ],
    });

    container.appendChild(plot);
  }

  function updateGeoMaps() {
    const filterValue = (
      document.getElementById("filtreEquipementGeo") as HTMLSelectElement
    ).value;
    const filteredBdx = filterGeoData(dataBdxFull, filterValue);
    const filteredMtp = filterGeoData(dataMtpFull, filterValue);

    renderGeoBordeaux(filteredBdx);
    renderGeoMontpellier(filteredMtp);
  }

  function initGeoMaps() {
    if (geoMapsInitialized) {
      updateGeoMaps();
      return;
    }

    const dataLoaded = loadGeoData();
    if (!dataLoaded) return;

    updateGeoMaps();

    document
      .getElementById("filtreEquipementGeo")
      ?.addEventListener("change", updateGeoMaps);

    geoMapsInitialized = true;
  }

  function switchToLeaflet() {
    currentMapMode = "leaflet";
    document.getElementById("leaflet-container")!.classList.remove("hidden");
    document.getElementById("geojson-container")!.classList.add("hidden");

    const btnLeaflet = document.getElementById("btn-leaflet")!;
    const btnGeojson = document.getElementById("btn-geojson")!;

    btnLeaflet.classList.add("bg-[#111111]", "text-white");
    btnLeaflet.classList.remove("text-gray-700", "hover:bg-gray-100");
    btnGeojson.classList.remove("bg-[#111111]", "text-white");
    btnGeojson.classList.add("text-gray-700", "hover:bg-gray-100");

    if (mapBordeaux && mapMontpellier) {
      setTimeout(() => {
        mapBordeaux.invalidateSize();
        mapMontpellier.invalidateSize();
      }, 100);
    }
  }

  function switchToGeojson() {
    currentMapMode = "geojson";
    document.getElementById("leaflet-container")!.classList.add("hidden");
    document.getElementById("geojson-container")!.classList.remove("hidden");

    const btnLeaflet = document.getElementById("btn-leaflet")!;
    const btnGeojson = document.getElementById("btn-geojson")!;

    btnLeaflet.classList.remove("bg-[#111111]", "text-white");
    btnLeaflet.classList.add("text-gray-700", "hover:bg-gray-100");
    btnGeojson.classList.add("bg-[#111111]", "text-white");
    btnGeojson.classList.remove("text-gray-700", "hover:bg-gray-100");

    if (!geoMapsInitialized) {
      setTimeout(() => initGeoMaps(), 100);
    }
  }

  document
    .getElementById("btn-leaflet")
    ?.addEventListener("click", switchToLeaflet);
  document
    .getElementById("btn-geojson")
    ?.addEventListener("click", switchToGeojson);
</script>

<script
  type="application/json"
  id="data-lieux"
  set:html={JSON.stringify(LieuxParVilleType)}
/>

<script
  type="application/json"
  id="data-bordeaux-geo"
  set:html={JSON.stringify(bordeauxGeo)}
/>

<script
  type="application/json"
  id="data-montpellier-geo"
  set:html={JSON.stringify(montpellierGeo)}
/>

<script
  type="application/json"
  id="data-bordeaux"
  set:html={JSON.stringify(
    data.filter((d) => d.ville?.toLowerCase() === "bordeaux")
  )}
/>

<script
  type="application/json"
  id="data-montpellier"
  set:html={JSON.stringify(
    data.filter((d) => d.ville?.toLowerCase() === "montpellier")
  )}
/>
