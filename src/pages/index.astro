---
import PlotFigure from "../components/PlotFigure.astro";
import Layout from "../layouts/Layout.astro";
import * as Plot from "@observablehq/plot";
import data from "../assets/DataCulturelles2025.json";

const colors = {
  Bordeaux: "#0077B6",
  Montpellier: "#F77F00",
};

const DataCulturellesPhysiques2025 = data.filter(
  (d) => d.type_offre === "physique"
);

const populations = {
  Bordeaux: 1018000,
  Montpellier: 487000,
};

const LieuxParVilleType = ["Bordeaux", "Montpellier", "Talence"]
  .flatMap((ville) => {
    const typesOffre = ["physique", "num√©rique"];
    return typesOffre.map((type_offre) => {
      const lieux = data.filter(
        (d) => d.ville === ville && d.type_offre === type_offre
      ).length;
      const pop = populations[ville];

      return {
        ville,
        type_offre,
        lieux,
        habitants_par_lieu: pop && lieux > 0 ? Math.round(pop / lieux) : null,
      };
    });
  })
  .filter((d) => d.habitants_par_lieu !== null);

const DataBordeaux = data.filter((d) => d.ville === "Bordeaux");
const DataMontpellier = data.filter((d) => d.ville === "Montpellier");

const typesEquipements = Array.from(
  new Set(
    data
      .filter((d) => d.type_offre === "physique" && d.type_equipement)
      .map((d) => d.type_equipement)
  )
).sort();

const butterflyDataComplete = typesEquipements
  .map((type) => {
    const bordeauxCount = DataBordeaux.filter(
      (d) => d.type_equipement === type && d.type_offre === "physique"
    ).length;

    const montpellierCount = DataMontpellier.filter(
      (d) => d.type_equipement === type && d.type_offre === "physique"
    ).length;

    return [
      {
        type: type,
        count: -bordeauxCount,
        ville: "Bordeaux",
        countAbs: bordeauxCount,
      },
      {
        type: type,
        count: montpellierCount,
        ville: "Montpellier",
        countAbs: montpellierCount,
      },
    ];
  })
  .flat()
  .filter((d) => d.countAbs > 0);

const totalsByType = new Map();
butterflyDataComplete.forEach((d) => {
  const current = totalsByType.get(d.type) || 0;
  totalsByType.set(d.type, current + d.countAbs);
});

const equipementsPertinents = Array.from(totalsByType.entries())
  .filter(([type, count]) => count >= 3)
  .sort((a, b) => b[1] - a[1])
  .slice(0, 10)
  .map(([type]) => type);

const butterflyData = butterflyDataComplete.filter((d) =>
  equipementsPertinents.includes(d.type)
);

const equipementsDomain = Array.from(totalsByType.entries())
  .filter(([type]) => equipementsPertinents.includes(type))
  .sort((a, b) => b[1] - a[1])
  .map(([type]) => type);
---

<Layout>
  <section
    class="snap-section relative overflow-hidden bg-black min-h-screen flex items-center"
  >
    <div class="absolute inset-0">
      <img
        src="/src/assets/img/fond_bordeaux.jpg"
        alt="Carte de Bordeaux"
        class="w-full h-full object-cover opacity-30 grayscale"
      />
    </div>

    <div
      class="absolute inset-0 bg-gradient-to-b from-black/70 via-black/60 to-black/90"
    >
    </div>

    <div class="absolute inset-0 opacity-[0.02]">
      <div
        class="absolute inset-0"
        style="background-image: repeating-linear-gradient(0deg, transparent, transparent 1px, currentColor 1px, currentColor 2px), repeating-linear-gradient(90deg, transparent, transparent 1px, currentColor 1px, currentColor 2px); background-size: 40px 40px;"
      >
      </div>
    </div>

    <div class="container mx-auto px-6 relative z-10 w-full">
      <div class="max-w-5xl mx-auto text-center fade-in-section">
        <div
          class="text-xs uppercase tracking-[0.2em] text-base-content/40 mb-8"
        >
          SA√â 303 ‚Äî Datavisualisation
        </div>

        <h1 class="text-5xl md:text-7xl lg:text-8xl font-serif mb-8">
          Tradition<br />
          <span class="italic">vs</span><br />
          Innovation
        </h1>

        <p
          class="text-xl md:text-2xl text-base-content/60 mb-4 max-w-2xl mx-auto font-light"
        >
          Une exploration comparative des offres culturelles
        </p>

        <div
          class="flex items-center justify-center gap-6 mb-16 text-base-content/50"
        >
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-gray-400"></div>
            <span class="text-sm">Bordeaux</span>
          </div>
          <div class="w-px h-4 bg-base-content/20"></div>
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-white"></div>
            <span class="text-sm">Montpellier</span>
          </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 justify-center mb-20">
          <a
            href="#intro"
            class="btn bg-white text-black hover:bg-gray-200 btn-lg border-0"
          >
            D√©couvrir l'analyse
          </a>
          <a
            href="#about"
            class="btn btn-ghost btn-lg border border-white/20 hover:bg-white/10"
            >M√©thodologie</a
          >
        </div>

        <div
          class="grid grid-cols-1 md:grid-cols-3 gap-12 max-w-4xl mx-auto text-center"
        >
          <div>
            <div class="text-5xl md:text-6xl font-serif mb-2 text-gray-400">
              407
            </div>
            <div class="text-sm text-base-content/60">Monuments √† Bordeaux</div>
          </div>
          <div>
            <div class="text-5xl md:text-6xl font-serif mb-2 text-white">
              51
            </div>
            <div class="text-sm text-base-content/60">
              Festivals √† Montpellier
            </div>
          </div>
          <div>
            <div class="text-5xl md:text-6xl font-serif mb-2">8</div>
            <div class="text-sm text-base-content/60">Cat√©gories analys√©es</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section
    id="intro"
    class="snap-section bg-[#F2F2F2] min-h-screen flex items-center"
  >
    <div class="container mx-auto max-w-4xl px-6 py-24">
      <div class="space-y-8 fade-in-section">
        <div class="text-xs uppercase tracking-[0.3em] text-gray-500">
          Introduction
        </div>

        <h2
          class="text-4xl md:text-5xl lg:text-6xl font-serif text-[#111111] leading-tight"
        >
          Culture et num√©rique : une mutation territoriale
        </h2>

        <div class="prose prose-lg max-w-none">
          <p class="text-xl text-gray-700 leading-relaxed mb-6">
            Dans un monde dans lequel le num√©rique s'invite dans chaque domaine,
            la culture n'y √©chappe pas. Les institutions patrimoniales se
            digitalisent, les festivals se diffusent en ligne, les publics se
            diversifient. Dans ce mouvement, les villes deviennent des acteurs
            majeurs de cette mutation culturelle.
          </p>

          <p class="text-xl text-gray-700 leading-relaxed mb-6">
            Pour illustrer cela, notre √©tude se concentre sur deux acteurs qui
            partagent le statut de m√©tropole culturelle : <span
              class="font-semibold text-[#111111]">Bordeaux</span
            > et <span class="font-semibold text-[#111111]">Montpellier</span>.
            Toutefois, malgr√© leur statut commun, chacune conna√Æt une √©volution
            diff√©rente. Bordeaux incarne le visage d'une ville profond√©ment
            ancr√©e dans un patrimoine historique et mus√©al, tandis que
            Montpellier repr√©sente un p√¥le d'exp√©rimentation culturelle,
            num√©rique et un dynamisme dans l'√©v√©nementiel.
          </p>

          <p class="text-xl text-gray-700 leading-relaxed">
            √Ä travers notre √©tude, nous souhaitons comparer comment ces deux
            villes adoptent une strat√©gie bien diff√©rente concernant l'acc√®s √†
            la culture, croisant leur offre physique (lieux, √©quipements,
            √©v√©nements) et leur offre num√©rique (innovations, lieux de cr√©ation
            de contenus culturels num√©riques, m√©diations). Cela nous laisse une
            ouverture sur l'avenir de la culture en France, entre pr√©servation
            et transition num√©rique.
          </p>
        </div>
      </div>
    </div>
  </section>

  <section
    id="chapitre-01"
    class="snap-section bg-[#F2F2F2] min-h-screen flex items-center"
  >
    <div class="container mx-auto max-w-7xl px-6 py-24">
      <div class="fade-in-section">
        <div class="max-w-4xl mb-16">
          <div class="text-xs uppercase tracking-[0.2em] text-gray-500 mb-6">
            Chapitre 01
          </div>
          <h2 class="text-4xl md:text-6xl font-serif mb-6 text-[#111111]">
            Accessibilit√© culturelle physique et num√©rique
          </h2>
          <p class="text-lg text-gray-700 leading-relaxed max-w-3xl">
            Tout d'abord, il est important de comprendre les strat√©gies
            respectives de ces deux m√©tropoles. Pour cela, nous comparons le
            nombre d'habitants par lieu culturel et offre num√©rique propos√©e
            dans chaque ville, ce qui permet de visualiser la densit√© d'acc√®s.
          </p>
        </div>

        <div class="grid lg:grid-cols-2 gap-12 items-start mb-16">
          <div class="bg-white rounded-2xl p-8 shadow-sm">
            <div class="mb-6">
              <label class="text-sm font-semibold text-[#111111] mb-3 block">
                Type d'offre √† afficher :
              </label>
              <div class="flex gap-4">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="radio"
                    name="choixType"
                    value="physique"
                    checked
                    class="radio radio-sm radio-primary"
                  />
                  <span class="text-gray-700">Physique</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="radio"
                    name="choixType"
                    value="num√©rique"
                    class="radio radio-sm radio-primary"
                  />
                  <span class="text-gray-700">Num√©rique</span>
                </label>
              </div>
            </div>
            <div id="chart-container"></div>
          </div>

          <div class="space-y-8">
            <div>
              <h3 class="text-2xl md:text-3xl font-serif text-[#111111] mb-4">
                Montpellier, une strat√©gie tourn√©e vers l'avenir
              </h3>
              <p class="text-lg text-gray-700 leading-relaxed mb-4">
                √Ä travers ces r√©sultats, on observe clairement le positionnement
                de Montpellier comme la ville explorant les nouvelles formes de
                m√©diation num√©rique, avec <span
                  class="text-[#F77F00] font-semibold"
                  >44 273 habitants par offre num√©rique</span
                > contre <span class="text-[#0077B6] font-semibold"
                  >84 833 pour Bordeaux</span
                >.
              </p>
              <p class="text-lg text-gray-700 leading-relaxed">
                Montpellier offre une densit√© d'acc√®s √† l'innovation presque
                deux fois sup√©rieure √† celle de Bordeaux. Cela traduit un
                investissement fort visant √† rapprocher l'offre culturelle
                immat√©rielle de ses habitants, faisant d'elle la leader de
                l'accessibilit√© culturelle num√©rique dans cette comparaison.
              </p>
            </div>

            <div>
              <h3 class="text-2xl md:text-3xl font-serif text-[#111111] mb-4">
                Bordeaux, ancrage dans le patrimoine plus classique
              </h3>
              <p class="text-lg text-gray-700 leading-relaxed mb-4">
                √Ä l'inverse, Bordeaux maintient une forte accessibilit√© √† ses
                lieux culturels, avec <span class="text-[#0077B6] font-semibold"
                  >1 647 habitants par lieu culturel physique</span
                >. Bien que l√©g√®rement moins dense que Montpellier (1 517),
                cette donn√©e montre un maillage du territoire relativement fort.
              </p>
              <p class="text-lg text-gray-700 leading-relaxed">
                C'est le contraste avec le num√©rique qui r√©v√®le la strat√©gie de
                Bordeaux : le foss√© avec le num√©rique est colossal. En effet,
                l'offre num√©rique est <span class="font-semibold text-[#111111]"
                  >51,5 fois moins accessible</span
                > que l'offre physique ; inversement, pour Montpellier, l'offre num√©rique
                est <span class="font-semibold text-[#111111]"
                  >29,2 fois moins accessible</span
                > que l'offre physique.
              </p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-2xl p-8 border-l-4 border-[#111111]">
          <p class="text-xl text-gray-700 leading-relaxed italic">
            En somme, <span class="font-semibold text-[#0077B6]">Bordeaux</span>
            cherche la r√©invention en consolidant son patrimoine, l'offre physique
            √©tant prioritaire, tandis que <span
              class="font-semibold text-[#F77F00]">Montpellier</span
            > cherche la r√©invention en privil√©giant le partage de la culture par
            le biais du num√©rique.
          </p>
        </div>
      </div>
    </div>
  </section>

  <section
    id="chapitre-03"
    class="snap-section bg-[#F2F2F2] min-h-screen flex items-center"
  >
    <div class="container mx-auto max-w-7xl px-6 py-24">
      <div class="fade-in-section">
        <div class="max-w-5xl mb-16">
          <div class="text-xs uppercase tracking-[0.2em] text-gray-500 mb-6">
            Chapitre 03
          </div>
          <h2 class="text-4xl md:text-6xl font-serif mb-6 text-[#111111]">
            Top 10 des √©quipements culturels
          </h2>
          <p class="text-lg text-gray-700 leading-relaxed">
            Apr√®s avoir √©tabli la densit√© globale et la r√©partition spatiale de
            l'offre, il est crucial de comprendre ce qui compose r√©ellement
            l'offre physique de Bordeaux et Montpellier. Cette troisi√®me
            visualisation nous permet de passer √† la structure m√™me du
            patrimoine culturel. En comparant le nombre d'√©quipements dans les
            dix cat√©gories principales, nous pouvons d√©terminer les domaines
            d'investissement culturels prioritaires de chaque m√©tropole.
          </p>
        </div>

        <div class="bg-white rounded-2xl p-8 shadow-sm mb-12">
          <PlotFigure
            options={{
              title: "Top 10 des √©quipements culturels (2025)",
              subtitle:
                "Comparaison Bordeaux vs Montpellier ‚Äî √âquipements avec minimum 3 lieux",
              marginLeft: 180,
              marginRight: 220,
              marginBottom: 70,
              marginTop: 90,
              width: 1200,
              height: 480,
              style: {
                background: "linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%)",
                fontSize: 14,
                fontFamily: "Inter, system-ui, -apple-system, sans-serif",
                color: "#1a1a1a",
              },
              x: {
                label:
                  "‚Üê Bordeaux                                    Montpellier ‚Üí",
                labelAnchor: "center",
                labelOffset: 45,
                tickFormat: (d) => Math.abs(d),
                grid: true,
                nice: true,
                line: true,
                domain: [
                  -Math.min(
                    150,
                    Math.max(
                      ...butterflyData
                        .filter((d) => d.ville === "Bordeaux")
                        .map((d) => Math.abs(d.count))
                    ) * 1.1
                  ),
                  Math.min(
                    150,
                    Math.max(
                      ...butterflyData
                        .filter((d) => d.ville === "Montpellier")
                        .map((d) => d.count)
                    ) * 1.1
                  ),
                ],
                clamp: true,
              },
              y: {
                label: null,
                domain: equipementsDomain,
                tickSize: 0,
                tickPadding: 12,
                fontSize: 13,
              },
              color: {
                domain: ["Bordeaux", "Montpellier"],
                range: [colors.Bordeaux, colors.Montpellier],
                legend: true,
                label: "Ville",
                marginLeft: 100,
              },
              marks: [
                Plot.barX(butterflyData, {
                  x: "count",
                  y: "type",
                  fill: "ville",
                  insetTop: 3,
                  insetBottom: 3,
                  rx: 6,
                  tip: true,
                  title: (d) =>
                    `üèôÔ∏è ${d.ville}\nüèõÔ∏è ${d.type}\nüìä ${d.countAbs} √©quipement${
                      d.countAbs > 1 ? "s" : ""
                    }`,
                }),
                Plot.ruleX([0], {
                  stroke: "#1a1a1a",
                  strokeWidth: 3,
                }),
                Plot.text(
                  butterflyData.filter(
                    (d) => d.ville === "Bordeaux" && d.countAbs > 0
                  ),
                  {
                    x: (d) => Math.max(d.count, -150),
                    y: "type",
                    text: (d) => d.countAbs.toString(),
                    dx: -12,
                    fill: "#ffffff",
                    fontSize: 12,
                    fontWeight: "700",
                  }
                ),
                Plot.text(
                  butterflyData.filter(
                    (d) => d.ville === "Montpellier" && d.countAbs > 0
                  ),
                  {
                    x: (d) => Math.min(d.count, 150),
                    y: "type",
                    text: (d) => d.countAbs.toString(),
                    dx: 12,
                    fill: "#ffffff",
                    fontSize: 12,
                    fontWeight: "700",
                  }
                ),
                Plot.text(
                  equipementsDomain.map((type) => {
                    const dataType = butterflyData.filter(
                      (d) => d.type === type
                    );
                    const bordeaux =
                      dataType.find((d) => d.ville === "Bordeaux")?.countAbs ||
                      0;
                    const montpellier =
                      dataType.find((d) => d.ville === "Montpellier")
                        ?.countAbs || 0;
                    const total = bordeaux + montpellier;
                    return {
                      type,
                      total,
                      label: `Total: ${total}`,
                    };
                  }),
                  {
                    x: 150,
                    y: "type",
                    text: "label",
                    dx: 55,
                    textAnchor: "start",
                    fill: "#495057",
                    fontSize: 12,
                    fontWeight: "700",
                    stroke: "#ffffff",
                    strokeWidth: 2,
                    paintOrder: "stroke",
                  }
                ),
              ],
            }}
          />
        </div>

        <div class="bg-white rounded-2xl p-8 border-l-4 border-[#111111]">
          <p class="text-lg text-gray-700 leading-relaxed">
            Ce graphique r√©v√®le les forces historiques des deux villes et met en
            lumi√®re les secteurs qui soutiennent l'accessibilit√© physique
            observ√©e pr√©c√©demment. L'analyse de la structure de l'offre physique
            renforce l'id√©e que les deux villes, en particulier Bordeaux,
            s'appuient fortement sur leur h√©ritage patrimonial, mais avec des
            diff√©rences notables dans la mani√®re dont cette offre est maill√©e.
          </p>
        </div>
      </div>
    </div>
  </section>

  <div
    id="progress-indicator"
    class="fixed right-8 top-1/2 -translate-y-1/2 z-50 hidden md:flex flex-col gap-3 opacity-0 transition-opacity duration-500"
  >
    <a
      href="#intro"
      class="progress-dot w-2 h-2 rounded-full bg-black/30 hover:bg-black/60 transition-all duration-300"
      data-section="0"></a>
    <a
      href="#chapitre-01"
      class="progress-dot w-2 h-2 rounded-full bg-black/30 hover:bg-black/60 transition-all duration-300"
      data-section="1"></a>
    <a
      href="#chapitre-03"
      class="progress-dot w-2 h-2 rounded-full bg-black/30 hover:bg-black/60 transition-all duration-300"
      data-section="2"></a>
  </div>
</Layout>

<style>
  :global(html) {
    scroll-behavior: smooth;
  }

  .snap-section {
  }

  .fade-in-section {
    opacity: 0;
    transform: translateY(40px);
    transition:
      opacity 1.2s cubic-bezier(0.4, 0, 0.2, 1),
      transform 1.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .fade-in-section.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .progress-dot.active {
    background-color: #111111;
    width: 0.75rem;
    height: 0.75rem;
  }

  .prose p {
    margin-bottom: 1.5rem;
  }

  @media (prefers-reduced-motion: reduce) {
    :global(html) {
      scroll-behavior: auto;
    }

    .fade-in-section {
      transition: none;
      opacity: 1;
      transform: none;
    }
  }
</style>

<script>
  declare global {
    interface Window {
      Plot: any;
      d3: any;
    }
  }

  const observerOptions = {
    threshold: 0.2,
    rootMargin: "0px 0px -10% 0px",
  };

  const fadeObserver = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        entry.target.classList.add("visible");
      }
    });
  }, observerOptions);

  document.querySelectorAll(".fade-in-section").forEach((section) => {
    fadeObserver.observe(section);
  });

  const storytellingSections = [
    document.getElementById("intro"),
    document.getElementById("chapitre-01"),
    document.getElementById("chapitre-03"),
  ];
  const progressIndicator = document.getElementById("progress-indicator");
  const progressDots = document.querySelectorAll(".progress-dot");

  const sectionObserver = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const index = storytellingSections.indexOf(
            entry.target as HTMLElement
          );
          if (index !== -1) {
            progressDots.forEach((dot, i) => {
              if (i === index) {
                dot.classList.add("active");
              } else {
                dot.classList.remove("active");
              }
            });
          }
        }
      });
    },
    { threshold: 0.5 }
  );

  storytellingSections.forEach((section) => {
    if (section) sectionObserver.observe(section);
  });

  const heroSection = document.querySelector(".snap-section");
  const heroObserver = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          progressIndicator?.classList.add("opacity-0");
        } else {
          progressIndicator?.classList.remove("opacity-0");
        }
      });
    },
    { threshold: 0.3 }
  );

  if (heroSection) heroObserver.observe(heroSection);

  const LieuxParVilleTypeData = JSON.parse(
    document.getElementById("data-lieux")?.textContent || "[]"
  );

  const colors = {
    Bordeaux: "#0077B6",
    Montpellier: "#F77F00",
  };

  function renderChart(choixType) {
    const container = document.getElementById("chart-container");
    if (!container || !window.Plot) return;

    container.innerHTML = "";

    const filteredData = LieuxParVilleTypeData.filter(
      (d) => d.type_offre === choixType
    );

    const plot = window.Plot.plot({
      title: "Accessibilit√© culturelle selon le type d'offre (2025)",
      subtitle: `Nombre d'habitants par ${
        choixType === "physique" ? "lieu culturel physique" : "offre num√©rique"
      } ‚Äî Bordeaux vs Montpellier`,
      height: 480,
      marginLeft: 100,
      marginBottom: 70,
      marginTop: 80,
      width: 560,
      style: {
        background: "linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%)",
        fontSize: "14px",
        fontFamily: "Inter, system-ui, -apple-system, sans-serif",
        color: "#111111",
      },
      x: {
        label: "Ville",
        domain: ["Bordeaux", "Montpellier"],
        tickSize: 0,
      },
      y: {
        grid: true,
        label:
          choixType === "physique"
            ? "‚Üë Habitants par offre culturelle physique"
            : "‚Üë Habitants par offre culturelle num√©rique",
        labelAnchor: "top",
        labelOffset: 40,
        tickFormat: "~s",
      },
      color: {
        domain: ["Bordeaux", "Montpellier"],
        range: [colors.Bordeaux, colors.Montpellier],
        legend: true,
        label: "Ville",
      },
      marks: [
        window.Plot.ruleY([0], { stroke: "#333", strokeWidth: 1.5 }),
        window.Plot.barY(filteredData, {
          x: "ville",
          y: "habitants_par_lieu",
          fill: "ville",
          rx: 8,
          tip: {
            fill: "#ffffff",
            stroke: (d) =>
              d.ville === "Bordeaux" ? colors.Bordeaux : colors.Montpellier,
            strokeWidth: 3,
            fontSize: "14px",
          },
          title: (d) =>
            `üèôÔ∏è ${d.ville} ‚Äî ${
              d.type_offre === "physique" ? "Offre physique" : "Offre num√©rique"
            }\n\nüë• ${d.habitants_par_lieu
              ?.toFixed(0)
              .replace(/\B(?=(\d{3})+(?!\d))/g, " ")} habitants/${
              d.type_offre === "physique" ? "lieu" : "offre"
            }\nüèõÔ∏è ${d.lieux} ${d.type_offre === "physique" ? "lieu" : "offre"}${
              d.lieux > 1 ? "s" : ""
            }`,
        }),
        window.Plot.text(filteredData, {
          x: "ville",
          y: (d) => d.habitants_par_lieu + d.habitants_par_lieu * 0.04,
          text: (d) => d.habitants_par_lieu.toLocaleString("fr-FR"),
          textAnchor: "middle",
          fill: "#111111",
          fontSize: 18,
          fontWeight: "700",
          stroke: "#ffffff",
          strokeWidth: 3,
          paintOrder: "stroke",
        }),
        window.Plot.text(filteredData, {
          x: "ville",
          y: (d) => d.habitants_par_lieu * 0.5,
          text: (d) =>
            `${d.lieux} ${choixType === "physique" ? "lieu" : "offre"}${
              d.lieux > 1 ? (choixType === "physique" ? "x" : "s") : ""
            }`,
          textAnchor: "middle",
          fill: "#ffffff",
          fontSize: 15,
          fontWeight: "600",
          opacity: 0.95,
        }),
      ],
    });

    container.appendChild(plot);
  }

  const radioInputs = document.querySelectorAll('input[name="choixType"]');
  radioInputs.forEach((input) => {
    input.addEventListener("change", (e) => {
      renderChart((e.target as HTMLInputElement).value);
    });
  });

  function initChart() {
    if (window.Plot) {
      renderChart("physique");
    } else {
      setTimeout(initChart, 100);
    }
  }

  initChart();
</script>

<script
  type="application/json"
  id="data-lieux"
  set:html={JSON.stringify(LieuxParVilleType)}
/>
